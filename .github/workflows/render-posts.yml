name: Render Weekly Posts (TidyTuesday/MakeoverMonday)

on:
  workflow_dispatch:
    inputs:
      post_type:
        description: 'Post type to render'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tidytuesday
          - makeover-monday
      post_date:
        description: 'Specific date (YYYY-MM-DD) or leave empty for all'
        required: false
        default: ''
        type: string

env:
  QUARTO_PROJECT_DIR: scripts/by_timeSeries/quarto

jobs:
  render:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.0'
          use-public-rspm: true

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            any::tidyverse
            any::lubridate
            any::scales
            any::ggplot2
            any::glue
            any::here
            any::arrow
            any::knitr
            any::rmarkdown
            any::patchwork

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy plotly pyarrow jupyter kaleido yfinance cairosvg

      - name: Convert thumbnail SVG to PNG (for X/SNS cards)
        run: |
          cd ${{ env.QUARTO_PROJECT_DIR }}/posts
          for dir in *-makeover-monday *-tidytuesday; do
            if [ -d "$dir" ] && [ -f "$dir/thumbnail.svg" ]; then
              echo "Converting $dir/thumbnail.svg -> thumbnail.png"
              python -m cairosvg "$dir/thumbnail.svg" -o "$dir/thumbnail.png" || echo "âš ï¸ Convert failed: $dir"
            fi
          done

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        # Use latest stable version (no version specified)

      - name: Find posts to render
        id: find-posts
        run: |
          cd ${{ env.QUARTO_PROJECT_DIR }}/posts
          
          POST_TYPE="${{ github.event.inputs.post_type }}"
          POST_DATE="${{ github.event.inputs.post_date }}"
          
          # Build pattern based on input
          if [ "$POST_TYPE" = "tidytuesday" ]; then
            PATTERN="*-tidytuesday"
          elif [ "$POST_TYPE" = "makeover-monday" ]; then
            PATTERN="*-makeover-monday"
          else
            PATTERN="*-tidytuesday *-makeover-monday"
          fi
          
          # Find matching directories
          POSTS=""
          for p in $PATTERN; do
            for dir in $p/; do
              if [ -d "$dir" ]; then
                # Filter by date if specified
                if [ -n "$POST_DATE" ]; then
                  if [[ "$dir" == *"$POST_DATE"* ]]; then
                    POSTS="$POSTS $dir"
                  fi
                else
                  POSTS="$POSTS $dir"
                fi
              fi
            done
          done
          
          echo "Found posts: $POSTS"
          echo "posts=$POSTS" >> $GITHUB_OUTPUT

      - name: Prepare TidyTuesday data
        if: contains(github.event.inputs.post_type, 'tidytuesday') || github.event.inputs.post_type == 'all'
        run: |
          cd ${{ env.QUARTO_PROJECT_DIR }}
          
          for post_dir in posts/*-tidytuesday/; do
            if [ -d "$post_dir" ] && [ -f "${post_dir}prepare_data.py" ]; then
              echo "ðŸ“Š Preparing data for: $post_dir"
              python "${post_dir}prepare_data.py" || echo "âš ï¸ Data prep failed: $post_dir"
            fi
          done

      - name: Render TidyTuesday posts (R)
        if: contains(github.event.inputs.post_type, 'tidytuesday') || github.event.inputs.post_type == 'all'
        run: |
          cd ${{ env.QUARTO_PROJECT_DIR }}
          
          for post_dir in posts/*-tidytuesday/; do
            if [ -d "$post_dir" ] && [ -f "${post_dir}index.qmd" ]; then
              echo "ðŸ“ Rendering: ${post_dir}index.qmd"
              # Render from project root to maintain navigation context
              quarto render "${post_dir}index.qmd" || echo "âš ï¸ Failed: $post_dir"
            fi
          done

      - name: Render MakeoverMonday posts (Python)
        if: contains(github.event.inputs.post_type, 'makeover-monday') || github.event.inputs.post_type == 'all'
        run: |
          cd ${{ env.QUARTO_PROJECT_DIR }}
          
          for post_dir in posts/*-makeover-monday/; do
            if [ -d "$post_dir" ] && [ -f "${post_dir}index.qmd" ]; then
              echo "ðŸ“ Rendering: ${post_dir}index.qmd"
              # Render from project root to maintain navigation context
              quarto render "${post_dir}index.qmd" || echo "âš ï¸ Failed: $post_dir"
            fi
          done

      - name: Add rendered posts to X queue
        run: |
          POST_TYPE="${{ github.event.inputs.post_type }}"
          POST_DATE="${{ github.event.inputs.post_date }}"
          
          cd ${{ env.QUARTO_PROJECT_DIR }}
          
          # TidyTuesday posts
          if [ "$POST_TYPE" = "tidytuesday" ] || [ "$POST_TYPE" = "all" ]; then
            for post_dir in posts/*-tidytuesday/; do
              if [ -d "$post_dir" ]; then
                # Filter by date if specified
                if [ -n "$POST_DATE" ]; then
                  if [[ "$post_dir" == *"$POST_DATE"* ]]; then
                    echo "ðŸ“¬ Adding to X queue: $post_dir"
                    python ../../../.github/scripts/add_to_queue.py --post-dir "$post_dir" || echo "âš ï¸ Queue add failed: $post_dir"
                  fi
                else
                  echo "ðŸ“¬ Adding to X queue: $post_dir"
                  python ../../../.github/scripts/add_to_queue.py --post-dir "$post_dir" || echo "âš ï¸ Queue add failed: $post_dir"
                fi
              fi
            done
          fi
          
          # MakeoverMonday posts
          if [ "$POST_TYPE" = "makeover-monday" ] || [ "$POST_TYPE" = "all" ]; then
            for post_dir in posts/*-makeover-monday/; do
              if [ -d "$post_dir" ]; then
                # Filter by date if specified
                if [ -n "$POST_DATE" ]; then
                  if [[ "$post_dir" == *"$POST_DATE"* ]]; then
                    echo "ðŸ“¬ Adding to X queue: $post_dir"
                    python ../../../.github/scripts/add_to_queue.py --post-dir "$post_dir" || echo "âš ï¸ Queue add failed: $post_dir"
                  fi
                else
                  echo "ðŸ“¬ Adding to X queue: $post_dir"
                  python ../../../.github/scripts/add_to_queue.py --post-dir "$post_dir" || echo "âš ï¸ Queue add failed: $post_dir"
                fi
              fi
            done
          fi

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain docs/ .github/x-post-queue.json)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Changes detected in docs/ or queue"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Commit and push
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docs/
          git add ${{ env.QUARTO_PROJECT_DIR }}/_freeze/ || true
          git add .github/x-post-queue.json || true
          
          COMMIT_MSG="ðŸŽ¨ Render weekly posts (${{ github.event.inputs.post_type }})"
          if [ -n "${{ github.event.inputs.post_date }}" ]; then
            COMMIT_MSG="$COMMIT_MSG - ${{ github.event.inputs.post_date }}"
          fi
          
          git commit -m "$COMMIT_MSG"
          
          # ãƒªãƒ¢ãƒ¼ãƒˆã«æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒã‚ã‚‹å ´åˆã«å‚™ãˆã¦ rebase ã—ã¦ã‹ã‚‰ push
          # ï¼ˆãƒ­ãƒ¼ã‚«ãƒ« push ã¨ CI ãŒç«¶åˆã—ãŸå ´åˆã®ãƒªãƒˆãƒ©ã‚¤ï¼‰
          for i in 1 2 3; do
            git push && break
            echo "âš ï¸ Push failed (attempt $i/3), pulling with rebase..."
            git pull --rebase origin main
          done

      - name: Summary
        run: |
          echo "## ðŸ“Š Render Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Post Type**: ${{ github.event.inputs.post_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date Filter**: ${{ github.event.inputs.post_date || 'All' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Committed**: ${{ steps.check-changes.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
