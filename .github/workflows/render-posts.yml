name: Render Weekly Posts (TidyTuesday/MakeoverMonday)

on:
  workflow_dispatch:
    inputs:
      post_type:
        description: 'Post type to render'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tidytuesday
          - makeover-monday
      post_date:
        description: 'Specific date (YYYY-MM-DD) or leave empty for all'
        required: false
        default: ''
        type: string

env:
  QUARTO_PROJECT_DIR: scripts/by_timeSeries/quarto

jobs:
  render:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.0'
          use-public-rspm: true

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            any::tidyverse
            any::lubridate
            any::scales
            any::ggplot2
            any::glue
            any::here
            any::arrow
            any::knitr
            any::rmarkdown
            any::patchwork

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy plotly pyarrow jupyter kaleido yfinance cairosvg

      - name: Convert thumbnail SVG to PNG (for X/SNS cards)
        run: |
          cd ${{ env.QUARTO_PROJECT_DIR }}/posts
          for dir in *-makeover-monday *-tidytuesday; do
            if [ -d "$dir" ] && [ -f "$dir/thumbnail.svg" ]; then
              echo "Converting $dir/thumbnail.svg -> thumbnail.png"
              python -m cairosvg "$dir/thumbnail.svg" -o "$dir/thumbnail.png" || echo "âš ï¸ Convert failed: $dir"
            fi
          done

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Prepare TidyTuesday data
        if: contains(github.event.inputs.post_type, 'tidytuesday') || github.event.inputs.post_type == 'all'
        run: |
          cd ${{ env.QUARTO_PROJECT_DIR }}

          for post_dir in posts/*-tidytuesday/; do
            if [ -d "$post_dir" ] && [ -f "${post_dir}prepare_data.py" ]; then
              echo "ðŸ“Š Preparing data for: $post_dir"
              python "${post_dir}prepare_data.py" || echo "âš ï¸ Data prep failed: $post_dir"
            fi
          done

      - name: Render TidyTuesday posts (R)
        if: contains(github.event.inputs.post_type, 'tidytuesday') || github.event.inputs.post_type == 'all'
        run: |
          cd ${{ env.QUARTO_PROJECT_DIR }}

          for post_dir in posts/*-tidytuesday/; do
            if [ -d "$post_dir" ] && [ -f "${post_dir}index.qmd" ]; then
              echo "ðŸ“ Rendering: ${post_dir}index.qmd"
              quarto render "${post_dir}index.qmd" || echo "âš ï¸ Failed: $post_dir"
            fi
          done

      - name: Render MakeoverMonday posts (Python)
        if: contains(github.event.inputs.post_type, 'makeover-monday') || github.event.inputs.post_type == 'all'
        run: |
          cd ${{ env.QUARTO_PROJECT_DIR }}

          for post_dir in posts/*-makeover-monday/; do
            if [ -d "$post_dir" ] && [ -f "${post_dir}index.qmd" ]; then
              echo "ðŸ“ Rendering: ${post_dir}index.qmd"
              quarto render "${post_dir}index.qmd" || echo "âš ï¸ Failed: $post_dir"
            fi
          done

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain docs/)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Changes detected in docs/"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Commit and push
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add docs/
          git add ${{ env.QUARTO_PROJECT_DIR }}/_freeze/ || true

          COMMIT_MSG="ðŸŽ¨ Render weekly posts (${{ github.event.inputs.post_type }})"
          if [ -n "${{ github.event.inputs.post_date }}" ]; then
            COMMIT_MSG="$COMMIT_MSG - ${{ github.event.inputs.post_date }}"
          fi

          git commit -m "$COMMIT_MSG"

          for i in 1 2 3; do
            git push && break
            echo "âš ï¸ Push failed (attempt $i/3), pulling with rebase..."
            git pull --rebase origin main
          done

      - name: Summary
        run: |
          echo "## ðŸ“Š Render Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Post Type**: ${{ github.event.inputs.post_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date Filter**: ${{ github.event.inputs.post_date || 'All' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Committed**: ${{ steps.check-changes.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
